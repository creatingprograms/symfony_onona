# onona.ru

## Общая структура

### Функциональные части

Структурно проект состоит из следующих функциональных частей:

- административный режим;
- сценарии периодического запуска, взаимодействующие с внешними сервисами;

В основном каждая функциональная часть реализована в виде приложения Symfony 1. Такое приложение представляет собой набор PHP-файлов, реализующих классы слоя модели, контроллеры и шаблоны, необходимые для работы модуля.

Несмотря на то, что используемая версия фреймворка является устаревшей и больше не поддерживается, на сайте фреймворка доступна полная документация по этой версии. В частности, доступен вводный материал [A Gentle Introduction to Symfony].

[A Gentle Introduction to Symfony]: http://symfony.com/legacy/doc/gentle-introduction
[Разработка проекта на русском](http://symfony.com/legacy/doc/jobeet/1_4/ru/01?orm=Doctrine)

### Файловая структура проекта

Файловая структура исполняемой части проекта, в целом соответствует типовой файловой структуре проекта Symfony v.1.

С учетом функционального состава проекта общая структура выглядит следующим образом:

```
apps/                               — код приложений symfony, составляющхих проект
bin/                                — исполняемые сценарии
config/                             — конфигурационные файлы
   autoload.yml                     — конфигурация загрузчика классов
   databases.yml                    — подключение к базе данных
   doctrine/                        — конфигурация ORM
   error/                           — шаблоны страниц сообщения об ошибке
   ProjectConfiguration.class.php   — общий класс конфигурации проекта
   properties.ini
gulpfile.js        — правила сборки клиентской части (css, js)
lib/               — сторонние модули библиотеки, включая фреймворк
Makefile           — точка входа сборки
node_modules       — модули для сборки клиентской части
onona.ru → web     — симлинк для совместимости с предыдущим 
                     хостингом
package-lock.json  — список модулей сборки клиентской части
plugins/           — плагины Symfony
src/               — исходные файлы клиентской части
symfony            — запуск сценариев Symfony
var/               — пользовательский контент, общий между версиями

web/               — DOCUMENT_ROOT
```

### Общий код приложений

Код, используемый несколькими приложениями, реализуется в виде классов каталога `lib`. На данный момент каталог имеет следующую структуру:

```
filter/                — классы фильтров для выборки сущностей модели
form/                  — классы форм сущностей модели
migration/             — классы миграций базы данных
model/                 — классы сущностей модели
Slugify.class.php
task/                  — классы команд командной строки, в т.ч. запускаемых из cron
validator/             — классы валидаторов
vendor/                — внешние библиотеки
widget/                — классы визуальных элементов
```

Подкаталог `vendor` содержит код сторонних библиотек и не содержит код собственно приложения.

Что касается остальных каталогов, то необходимо обратить внимание на следующие моменты:

1. часть приложения, запускаемая в режиме командной строки, реализуется в виде классов задач в каталоге `task`.
2. функциональность, относящаяся к бизнес логике, а именно, определение хранимой в базе сущности, стандартная форма редактирования сущности, ее правила валидации и интерфейс выборки определяются в виде классов в каталогах `model`, `form`, `validator` и `filter` соответственно.

### Собственный код приложений

Каждое отдельное приложение представляет собой набор контроллеров, вызываемых для обработки запроса через единую точку входа. Например, все запросы к десктопной версии сайта обрабатываются через точку входа в виде файла `web/index.php`.

Каждое приложение имеет типовую файловую структуру (на примере десктопной версии) (реализуется приложением `new`):

```
config/                           — конфигурация приложения
   app.yml
   cache.yml
   factories.yml
   filters.yml
   newcatConfiguration.class.php
   routing.yml                    — роутинг, устанавливает соответствие адреса модулю
   security.yml
   settings.yml
   view.yml
   i18n/                          — файлы локализации
      ru/
lib/                              — библиотечные классы
   mySessionStorage.php
   myUser.class.php
   SxGeoCity.dat
   SxGeoCity_old.dat
   SxGeo.php
modules/                          — модули (контроллер + шаблоны + конфигурация)
   article/
   cart_new/
   customer/
   noncache/
   page/
   product/
   sfGuardRegister/
templates/                        — шаблоны страниц приложения
   layout.php
```

Модуль приложения включает в себя контроллер приложения, набор шаблонов и дополнительные параметры конфигурации. Файловая структура модуля выглядит следующим образом:

```
modules/article
   actions/
      actions.class.php        — контроллер
   config/                     — дополнительная конфигурация
      cache.yml
   templates/                  — шаблоны
      addcommentSuccess.php
      catalogSuccess.php
      categorySuccess.php
      editSuccess.php
      _form.php
      indexSuccess.php
      newSuccess.php
      rateSuccess.php
      showSuccess.php
```

Непосредственно обработчик запроса реализуется в виде метода с именем вида `execute*`, получающего в качестве параметра объект HTTP-запроса. Привязка имени метода к адресу запроса выполняется на уровне приложения в конфигурационном файле определения роутинга.  Файл определения роутинга записан в формате YAML, легко читается и дает полное представление о реализованной функциональности, нет необходимости в его дублировании и дополнительном описании в этом документе.

## Административный режим

Административный режим реализуется приложением `backend`, имеющим стандартную структуру приложения Symfony1.

Каждый класс сущностей редактируется отдельным модулем. При этом в большинстве случаев в качестве базового класса контроллера используется сгенерированный автоматически класс, код которого находится в каталоге `cache`, например, `cache/backend/prod/modules/autoArticle/actions/actions.class.php`.